<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MotoLog - Tools</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
  <div class="dashboard-container">
    {% set is_mobile = is_mobile() if is_mobile is not defined else is_mobile %}
    {% include '_navbar.html' %}

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="flash-message {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div style="margin-top:72px;"></div>
    <h2 style="margin-bottom:1.5rem; color:var(--text); font-size:1.5em; font-weight:800; text-align:center;">ðŸ§° Tools</h2>

    <div class="leaderboard-tabs" style="margin-bottom:1.5rem;">
      <button class="tab-button active" data-tab="maint" onclick="showTab('maint', this)">Maintenance Reminders</button>
      <button class="tab-button" data-tab="weather" onclick="showTab('weather', this)">Weather Alerts</button>
      <button class="tab-button" data-tab="emergency" onclick="showTab('emergency', this)">Emergency Info</button>
      <button class="tab-button" data-tab="gpx" onclick="showTab('gpx', this)">GPX Processing</button>
    </div>

    <div id="maint" class="leaderboard-table" style="display:block;">
      <h3>Your Maintenance</h3>
      <form method="POST" style="margin-bottom:1rem;">
        <input type="hidden" name="action" value="add_maintenance">
        <div class="form-group">
          <label>Item</label>
          <input name="item" placeholder="Oil change / Tire replacement" required>
        </div>
        <div class="form-group">
          <label>Due Date</label>
          <input type="date" name="due_date">
        </div>
        <div class="form-group">
          <label>Last Changed</label>
          <input type="date" name="last_changed">
        </div>
        <div class="form-group">
          <label>Notes</label>
          <input name="notes" placeholder="Notes (optional)">
        </div>
        <div class="form-group">
          <button class="post-btn" type="submit">Add Reminder</button>
        </div>
      </form>

      {% if maintenance %}
        <div>
        {% for m in maintenance %}
          <div class="stat-card" style="margin-bottom:10px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div><strong>{{ m['item'] }}</strong><div style="color:var(--muted);font-size:0.95rem;">Due: {{ m['due_date'] or '-' }}</div></div>
              <div><a class="btn btn-secondary" href="?delete_maint={{ m['id'] }}" onclick="return confirm('Delete?')">Delete</a></div>
            </div>
          </div>
        {% endfor %}
        </div>
      {% else %}
        <p class="empty-message">No maintenance reminders yet.</p>
      {% endif %}
    </div>

    <div id="weather" class="leaderboard-table" style="display:none;">
      <h3>Weather Alerts</h3>
      <form id="weatherForm" onsubmit="return false;">
        <div class="form-group">
          <label for="weatherCity">City</label>
          <input id="weatherCity" name="city" placeholder="Enter city (e.g. London)" required>
        </div>
        <div class="form-group">
          <button id="weatherBtn" class="post-btn" type="submit">Get Weather</button>
        </div>
      </form>

      <div id="weatherResult" style="margin-top:12px;"></div>
    </div>

    <div id="emergency" class="leaderboard-table" style="display:none;">
      <h3>Emergency Info</h3>
      <form method="POST">
        <input type="hidden" name="action" value="emergency">
        <div class="form-group">
          <label>Contact Name</label>
          <input name="em_name" value="{{ user['emergency_name'] or '' }}" placeholder="ICE Contact name">
        </div>
        <div class="form-group">
          <label>Contact Phone</label>
          <input name="em_phone" value="{{ user['emergency_phone'] or '' }}" placeholder="+1234567890">
        </div>
        <div class="form-group">
          <button class="post-btn" type="submit">Save Emergency Info</button>
        </div>
      </form>

      <div style="margin-top:1rem;">
        <h4>Quick Access</h4>
        <p>{{ user['emergency_name'] or 'No contact set' }} â€” {{ user['emergency_phone'] or '-' }}</p>
      </div>
    </div>

    <div id="gpx" class="leaderboard-table" style="display:none;">
      <h3>GPX File Processing</h3>
      <p>MotoLog now supports advanced GPX processing with road snapping and realistic speed simulation.</p>
      
      <h4>Features:</h4>
      <ul>
        <li><strong>Road Snapping:</strong> GPX routes are automatically snapped to real roads using OpenStreetMap data</li>
        <li><strong>Speed Simulation:</strong> Realistic speeds based on road types (motorways, city streets, etc.)</li>
        <li><strong>Traffic Simulation:</strong> Includes stops at traffic lights and variable speeds</li>
        <li><strong>Accurate Statistics:</strong> Proper distance, duration, and speed calculations</li>
      </ul>
      
      <h4>Setup Requirements:</h4>
      <p>To use road snapping, you need to set up OSRM (Open Source Routing Machine):</p>
      <ol>
        <li>Install OSRM backend on your server</li>
        <li>Download OpenStreetMap data for your region</li>
        <li>Start the OSRM routing service</li>
        <li>Set the <code>OSRM_URL</code> environment variable</li>
      </ol>
      
      <p><a href="/static/GPX_PROCESSING_README.md" target="_blank">ðŸ“– View detailed setup instructions</a></p>
      
      <h4>How to Use:</h4>
      <ol>
        <li>Go to the <a href="/track-ride">Track Ride</a> page</li>
        <li>Upload a GPX file using the GPX upload feature</li>
        <li>The system will process the file and simulate the ride with accurate road-following</li>
      </ol>
    </div>
  </div>

  <script>
    function showTab(id, btn) {
      ['maint','weather','emergency','gpx'].forEach(k => document.getElementById(k).style.display = (k===id ? 'block' : 'none'));
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
    }

    (function(){
      const apiKey = 'e0bdcc406de83a62a78c9f0a05072613';
      const form = document.getElementById('weatherForm');
      const cityInput = document.getElementById('weatherCity');
      const result = document.getElementById('weatherResult');

      async function getWeather(city) {
        result.innerHTML = '<div class="flash-message">Fetching weatherâ€¦</div>';
        try {
          const r = await fetch('https://api.openweathermap.org/data/2.5/weather?q=' + encodeURIComponent(city) + '&units=metric&appid=' + apiKey);
          if (!r.ok) throw new Error('City not found');
          const data = await r.json();
          const html = `
            <div class="stat-card">
              <h4>${data.name}, ${data.sys.country}</h4>
              <p>Temp: <strong>${data.main.temp}Â°C</strong></p>
              <p>Condition: <strong>${data.weather[0].description}</strong></p>
              <p>Wind: <strong>${data.wind.speed} m/s</strong></p>
            </div>
          `;
          result.innerHTML = html;
          const cond = data.weather[0].main.toLowerCase();
          if (cond.includes('storm') || cond.includes('thunder') || cond.includes('tornado') || cond.includes('hurricane')){
            alert('Severe weather alert: ' + data.weather[0].description);
          }
        } catch (err) {
          result.innerHTML = '<div class="flash-message error">Weather lookup failed: ' + err.message + '</div>';
        }
      }

      if (form) {
        form.addEventListener('submit', function(e){
          e.preventDefault();
          const city = cityInput.value.trim();
          if (!city) { result.innerHTML = '<div class="flash-message error">Please enter a city.</div>'; return; }
          getWeather(city);
        });
      }
    })();
  </script>
  <script>
    // Ensure dark mode theme is initialized on page load
    (function() {
      const saved = localStorage.getItem('moto_theme');
      if (saved === 'dark') document.body.classList.add('dark');
      else document.body.classList.remove('dark');
    })();
  </script>
</body>
</html>