<script>
document.addEventListener('DOMContentLoaded', function(){
  // Set initial theme from localStorage and update icon/vars
  const saved = localStorage.getItem('moto_theme');
  const themeToggleMobile = document.getElementById('themeToggle');
  const themeIconMobile = document.getElementById('themeIcon');
  const themeToggleDesktop = document.getElementById('themeToggleDesktop');
  const themeIconDesktop = document.getElementById('themeIconDesktop');
  function updateThemeVars(isDark) {
    document.documentElement.style.setProperty('--navbar-bg', isDark ? '#23242a' : '#f7f7f7');
    document.documentElement.style.setProperty('--navbar-link', isDark ? '#5a6cff' : '#3949ab');
    document.documentElement.style.setProperty('--navbar-link-active', '#fff');
  }
  function setThemeIcon(isDark){
    if (themeIconMobile) {
      themeIconMobile.innerHTML = isDark
        ? '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>'
        : '<path d="M12 3v2M12 19v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4M12 7a5 5 0 100 10 5 5 0 000-10z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>';
    }
    if (themeIconDesktop) {
      themeIconDesktop.innerHTML = isDark
        ? '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>'
        : '<path d="M12 3v2M12 19v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4M12 7a5 5 0 100 10 5 5 0 000-10z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>';
    }
  }
  if (saved === 'dark') document.body.classList.add('dark');
  else document.body.classList.remove('dark');
  const isDark = document.body.classList.contains('dark');
  setThemeIcon(isDark);
  updateThemeVars(isDark);
  if (themeToggleMobile) {
    themeToggleMobile.addEventListener('click', function(e){
      e.preventDefault();
      const nowDark = document.body.classList.toggle('dark');
      localStorage.setItem('moto_theme', nowDark ? 'dark' : 'light');
      setThemeIcon(nowDark);
      updateThemeVars(nowDark);
    });
  }
  if (themeToggleDesktop) {
    themeToggleDesktop.addEventListener('click', function(e){
      e.preventDefault();
      const nowDark = document.body.classList.toggle('dark');
      localStorage.setItem('moto_theme', nowDark ? 'dark' : 'light');
      setThemeIcon(nowDark);
      updateThemeVars(nowDark);
    });
  }
});
</script>
{% set ua = (request.headers.get('User-Agent', '') or '')|lower %}
{% set mobile_detected = is_mobile|default(false) or 'iphone' in ua or 'android' in ua or 'mobile' in ua or 'ipad' in ua or 'capacitor' in ua %}
<style>
@media (max-width: 900px) and (-webkit-touch-callout: none) {
  body .mobile-navbar.mobile-navbar--hamburger,
  body .navbar {
    top: calc(env(safe-area-inset-top, 0px) + 22px) !important;
    z-index: 12000 !important;
    pointer-events: auto !important;
  }

  body {
    padding-top: calc(env(safe-area-inset-top, 0px) + 78px) !important;
  }

  body .mobile-dashboard-container,
  body .container,
  body main {
    margin-top: calc(env(safe-area-inset-top, 0px) + 78px) !important;
  }
}
</style>
{% if mobile_detected %}
{% set u = query_db('SELECT profile_pic, username FROM users WHERE id = ?', (session['user_id'],), one=True) if session.get('user_id') else None %}
<header class="mobile-navbar mobile-navbar--hamburger" role="banner">
  <button id="mobileMenuToggle" class="icon-btn mobile-menu-toggle" type="button" aria-label="Open navigation menu" aria-expanded="false" aria-controls="mobileDrawerMenu">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
    </svg>
  </button>
  <a href="/dashboard" class="mobile-brand-link" aria-label="Go to dashboard">
    <img src="{{ url_for('static', filename='MotoLog_Logo.png') }}" class="logo-img" alt="MotoLog Logo">
    <span class="brand-text">MotoLog</span>
  </a>
  <div class="mobile-top-actions">
    <a href="/messages" class="icon-btn" title="Messages" aria-label="Messages">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M22 2L11 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
    </a>
    <a href="/profile" class="icon-btn" title="Profile" aria-label="Profile">
      {% if u and u['profile_pic'] %}
        <img src="{{ u['profile_pic'] }}" alt="Profile" style="width:24px;height:24px;border-radius:50%;object-fit:cover;">
      {% else %}
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="1.5"/><path d="M4 20c0-2.21 3.58-4 8-4s8 1.79 8 4" stroke="currentColor" stroke-width="1.5"/></svg>
      {% endif %}
    </a>
  <button id="themeToggle" class="icon-btn" title="Toggle dark mode" aria-label="Toggle dark mode" type="button">
    <svg id="themeIcon" width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
  </button>
  </div>
</header>

<div id="mobileDrawerBackdrop" class="mobile-drawer-backdrop" hidden></div>
<nav id="mobileDrawerMenu" class="mobile-drawer" aria-hidden="true">
  <div class="mobile-drawer-header">
    <div class="mobile-drawer-user">
      {% if u and u['profile_pic'] %}
        <img src="{{ u['profile_pic'] }}" alt="Profile" class="mobile-drawer-avatar">
      {% else %}
        <div class="mobile-drawer-avatar mobile-drawer-avatar-fallback">{{ u['username'][0].upper() if u else 'U' }}</div>
      {% endif %}
      <div class="mobile-drawer-username">{{ u['username'] if u else 'Guest' }}</div>
    </div>
    <button id="mobileMenuClose" class="icon-btn" type="button" aria-label="Close navigation menu">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
    </button>
  </div>

  <div class="mobile-drawer-search-wrap">
    <input id="mobileDrawerSearch" type="search" class="mobile-drawer-search" placeholder="Search riders..." aria-label="Search riders">
    <div id="mobileDrawerSearchResults" class="mobile-drawer-search-results"></div>
  </div>

  <a href="/dashboard" class="mobile-drawer-link">üè† Dashboard</a>
  <a href="/leaderboard" class="mobile-drawer-link">üèÜ Leaderboard</a>
  <a href="/tools" class="mobile-drawer-link">üõ†Ô∏è Tools</a>
  <a href="/events" class="mobile-drawer-link">üèçÔ∏è Events</a>
  <a href="/track-ride" class="mobile-drawer-link">üìç Track Ride</a>
  <a href="/ride_history" class="mobile-drawer-link">üìä My Rides</a>
  <a href="/messages" class="mobile-drawer-link">‚úâÔ∏è Messages</a>
  <a href="/notifications" class="mobile-drawer-link">üîî Notifications</a>
  <a href="/profile" class="mobile-drawer-link">üë§ My Profile</a>
  <a href="/bikes" class="mobile-drawer-link">üèçÔ∏è My Garage</a>
  <a href="/add-bike" class="mobile-drawer-link">‚ûï Add Bike</a>
  {% if session.get('user_id') %}
    <a href="{{ url_for('logout') }}" class="mobile-drawer-link">üö™ Logout</a>
  {% endif %}
</nav>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const toggleBtn = document.getElementById('mobileMenuToggle');
  const closeBtn = document.getElementById('mobileMenuClose');
  const drawer = document.getElementById('mobileDrawerMenu');
  const backdrop = document.getElementById('mobileDrawerBackdrop');
  const searchInput = document.getElementById('mobileDrawerSearch');
  const searchResults = document.getElementById('mobileDrawerSearchResults');

  if (!toggleBtn || !drawer || !backdrop) return;

  function setMenuState(open) {
    drawer.classList.toggle('open', open);
    backdrop.hidden = !open;
    drawer.setAttribute('aria-hidden', open ? 'false' : 'true');
    toggleBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
    document.body.classList.toggle('mobile-menu-open', open);
  }

  toggleBtn.addEventListener('click', function () {
    setMenuState(!drawer.classList.contains('open'));
  });

  if (closeBtn) {
    closeBtn.addEventListener('click', function () {
      setMenuState(false);
    });
  }

  backdrop.addEventListener('click', function () {
    setMenuState(false);
  });

  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') setMenuState(false);
  });

  let searchTimer = null;
  if (searchInput && searchResults) {
    searchInput.addEventListener('input', function () {
      const q = searchInput.value.trim();
      clearTimeout(searchTimer);
      if (!q) {
        searchResults.innerHTML = '';
        return;
      }
      searchTimer = setTimeout(function () {
        fetch('/search/users?q=' + encodeURIComponent(q))
          .then((r) => r.json())
          .then((data) => {
            const users = (data && data.users) ? data.users : [];
            if (!users.length) {
              searchResults.innerHTML = '<div class="mobile-search-empty">No users found</div>';
              return;
            }
            searchResults.innerHTML = users.map((user) => {
              const avatar = user.profile_pic
                ? `<img src="${user.profile_pic}" alt="${user.username}" class="mobile-search-avatar">`
                : `<div class="mobile-search-avatar mobile-search-avatar-fallback">${(user.username || 'U').charAt(0).toUpperCase()}</div>`;
              return `<a class="mobile-search-item" href="/user/${user.id}">${avatar}<span>${user.username}</span></a>`;
            }).join('');
          })
          .catch(() => {
            searchResults.innerHTML = '<div class="mobile-search-empty">Search unavailable</div>';
          });
      }, 220);
    });
  }

  drawer.querySelectorAll('a').forEach((link) => {
    link.addEventListener('click', function () {
      setMenuState(false);
    });
  });
});
</script>
{% else %}
<nav class="navbar">
  <div class="navbar-row" style="display:flex; align-items:center; gap:12px; width:100%;">
    <div class="brand">
      <img src="{{ url_for('static', filename='MotoLog_Logo.png') }}" alt="MotoLog" class="logo-img">
      <span class="brand-text">MotoLog</span>
    </div>
    <div class="nav-left">
      <a class="nav-link" href="/dashboard">Dashboard</a>
      <a class="nav-link" href="/leaderboard">Leaderboard</a>
      <a class="nav-link" href="/tools">Tools</a>
      <a href="{{ url_for('events_browse') }}" class="nav-link">üèçÔ∏è Events</a>
      <a class="nav-link" href="{{ url_for('track_ride') }}">üìç Track Ride</a>
      <a class="nav-link" href="{{ url_for('ride_history') }}">üìä My Rides</a>
    </div>
  </div>
  <div class="nav-actions" aria-hidden="false" style="position:static !important; display:flex; flex-direction:row; align-items:center; justify-content:flex-end; width:100%; margin-left:auto;">
    <!-- Search toggle -->
    <button id="searchToggle" class="icon-btn" title="Search users" aria-label="Search users">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.5"/><path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
    </button>
    <!-- Theme toggle (sun/moon icon) -->
    <button id="themeToggleDesktop" class="icon-btn" title="Toggle theme" aria-label="Toggle theme">
      <svg id="themeIconDesktop" width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M12 3v2M12 19v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4M12 7a5 5 0 100 10 5 5 0 000-10z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    {% if session.get('user_id') %}
      {% set u = query_db('SELECT profile_pic, username FROM users WHERE id = ?', (session['user_id'],), one=True) %}
      <a href="/notifications" id="notificationsLink" class="icon-btn" title="Notifications" aria-label="Notifications" style="position:relative;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
      <a href="/messages" id="messagesLink" class="icon-btn" title="Messages" aria-label="Messages" style="position:relative;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M22 2L11 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </svg>
      </a>
      <div class="profile" style="position:relative;">
        <a href="/profile" class="profile-avatar" title="Account">
          {% if u and u['profile_pic'] %}
            <img src="{{ u['profile_pic'] }}" alt="Profile">
          {% else %}
            <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; background:linear-gradient(135deg,var(--primary-500),var(--primary-600));">
              {{ u['username'][0].upper() if u else 'U' }}
            </div>
          {% endif %}
        </a>
        <div class="profile-menu">
          <a href="/profile">My profile</a>
          <a href="/bikes">My Garage</a>
          <a href="/add-bike">Add Bike</a>
          {% if session.get('user_id') %}
            <a href="{{ url_for('logout') }}">Logout</a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
</nav>
<!-- Search modal -->
<div id="navSearchModal">
  <div class="panel nav-search-panel">
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="navSearchInput" type="search" placeholder="Search users by username..." aria-label="Search users">
      <button id="navSearchClose" class="btn" style="background:transparent; color:var(--muted); padding:8px;">Close</button>
    </div>
    <div id="navSearchResults" style="margin-top:8px; max-height:320px; overflow:auto;"></div>
  </div>
</div>

<!-- Debug bar for safe area (remove after confirming notch fix) -->
<div class="safe-area-debug-bar"></div>

<script>
  // Initialize theme IMMEDIATELY (before DOMContentLoaded) so it applies on page load
  (function initTheme(){
    const saved = localStorage.getItem('moto_theme');
    const isDark = saved === 'dark';
    if (isDark) {
      document.body.classList.add('dark');
    } else {
      document.body.classList.remove('dark');
    }
  })();

  document.addEventListener('DOMContentLoaded', function(){
    // Profile menu: click to toggle, click outside or Escape to close
    const profileEl = document.querySelector('.profile');
    if (profileEl) {
      const avatar = profileEl.querySelector('.profile-avatar');
      if (avatar) {
        avatar.setAttribute('tabindex', '0');
        avatar.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); profileEl.classList.toggle('open'); });
        avatar.addEventListener('keydown', function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); profileEl.classList.toggle('open'); } });
      }
      // close when clicking outside
      document.addEventListener('click', function(e){ if (!profileEl.contains(e.target)) profileEl.classList.remove('open'); });
      // close on Escape
      document.addEventListener('keydown', function(e){ if (e.key === 'Escape') profileEl.classList.remove('open'); });
    }

    // Unread badge updater (only if logged in)
    function updateMessagesNotificationBadge() {
      const messagesLinks = document.querySelectorAll('a[href="/messages"]');
      if (messagesLinks.length === 0) return;
      
      fetch('/messages/unread-count')
        .then(response => response.json())
        .then(data => {
          messagesLinks.forEach(link => {
            if (data.unread_count > 0) {
              let badge = link.querySelector('.msg-unread-badge');
              if (!badge) {
                badge = document.createElement('span');
                badge.className = 'msg-unread-badge';
                link.appendChild(badge);
              }
              badge.textContent = data.unread_count > 99 ? '99+' : data.unread_count;
            } else {
              const badge = link.querySelector('.msg-unread-badge');
              if (badge) badge.remove();
            }
          });
        })
        .catch(err => console.error('Badge update error:', err));
    }

    // Notification badge updater
    function updateNotificationBadge() {
      const notifLinks = document.querySelectorAll('a[href="/notifications"]');
      if (notifLinks.length === 0) return;
      
      fetch('/api/notifications/count')
        .then(response => response.json())
        .then(data => {
          notifLinks.forEach(link => {
            if (data.count > 0) {
              let badge = link.querySelector('.notif-unread-badge');
              if (!badge) {
                badge = document.createElement('span');
                badge.className = 'notif-unread-badge';
                badge.style.cssText = 'position:absolute;top:-6px;right:-6px;background:#ff5555;color:white;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;border:2px solid var(--bg);';
                link.appendChild(badge);
              }
              badge.textContent = data.count > 99 ? '99+' : data.count;
            } else {
              const badge = link.querySelector('.notif-unread-badge');
              if (badge) badge.remove();
            }
          });
        })
        .catch(err => console.error('Notification badge error:', err));
    }
    
    updateMessagesNotificationBadge();
    updateNotificationBadge();
    setInterval(updateMessagesNotificationBadge, 3500);
    setInterval(updateNotificationBadge, 3500);

    // SEARCH modal behavior
    const toggle = document.getElementById('searchToggle');
    const modal = document.getElementById('navSearchModal');
    const input = document.getElementById('navSearchInput');
    const results = document.getElementById('navSearchResults');
    const closeBtn = document.getElementById('navSearchClose');
    if (toggle && modal && input && results) {
      toggle.addEventListener('click', function(e){
        e.preventDefault();
        modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        if (modal.style.display === 'block') { input.focus(); input.select(); results.innerHTML = ''; }
      });
      closeBtn.addEventListener('click', function(){ modal.style.display = 'none'; });
      let timer = null;
      input.addEventListener('input', function(){
        clearTimeout(timer);
        const q = input.value.trim();
        if (!q) { results.innerHTML = ''; return; }
        timer = setTimeout(() => {
          fetch('/search/users?q=' + encodeURIComponent(q))
            .then(r => r.json())
            .then(data => {
              results.innerHTML = '';
              if (!data.users || data.users.length === 0) {
                results.innerHTML = '<div style="padding:8px;color:var(--muted)">No users found</div>';
                return;
              }
              data.users.forEach(u => {
                const a = document.createElement('a');
                a.href = '/user/' + u.id;
                a.style.display = 'flex';
                a.style.gap = '10px';
                a.style.padding = '8px';
                a.style.alignItems = 'center';
                a.style.textDecoration = 'none';
                a.style.color = 'inherit';
                a.innerHTML = `
                  <div style="width:44px;height:44px;border-radius:10px;overflow:hidden;flex-shrink:0;border:1px solid color-mix(in srgb,var(--muted) 8%, transparent);">
                    ${u.profile_pic ? `<img src="${u.profile_pic}" style="width:100%;height:100%;object-fit:cover;">` : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--primary-500),var(--primary-600));color:white;font-weight:700">${u.username.charAt(0).toUpperCase()}</div>`}
                  </div>
                  <div style="flex:1;">
                    <div style="font-weight:700;">${u.username}</div>
                    <div style="color:var(--muted);font-size:0.85rem;">View profile</div>
                  </div>
                `;
                results.appendChild(a);
              });
            })
            .catch(err => { results.innerHTML = '<div style="padding:8px;color:#c00">Search failed</div>'; });
        }, 220);
      });
    }

    // Theme toggle logic
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');

    function setThemeIcon(isDark){
      if (!themeIcon) return;
      if (isDark) {
        // moon icon
        themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>';
      } else {
        // sun icon
        themeIcon.innerHTML = '<path d="M12 3v2M12 19v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4M12 7a5 5 0 100 10 5 5 0 000-10z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>';
      }
    }

    // Set icon based on current theme
    const isDark = document.body.classList.contains('dark');
    setThemeIcon(isDark);

    // Attach click listener to toggle
    if (themeToggle) {
      themeToggle.addEventListener('click', function(e){
        e.preventDefault();
        const nowDark = document.body.classList.toggle('dark');
        localStorage.setItem('moto_theme', nowDark ? 'dark' : 'light');
        setThemeIcon(nowDark);
      });
    }
  });
</script>
<script src="{{ url_for('static', filename='js/native-bridge.js') }}"></script>
{% endif %}

<style>
  /* Fix user search modal background in dark mode */
  .nav-search-panel {
    background: var(--card-bg, #fff);
    color: var(--text, #111);
    border-radius: 14px;
    box-shadow: 0 8px 32px rgba(15,23,36,0.13);
    padding: 18px 16px;
    transition: background 0.3s, color 0.3s;
  }
  body.dark .nav-search-panel {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), var(--card-bg, #23242a));
    color: var(--text, #f7f7f7);
  }
  #navSearchModal {
    z-index: 99999;
  }
</style>
