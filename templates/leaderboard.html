<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MotoLog ‚Äî Leaderboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
  <div class="dashboard-container">
    {% set is_mobile = is_mobile() if is_mobile is not defined else is_mobile %}
    {% if not request.args.get('app') %}
      {% if not request.args.get('app') %}
        {% include '_navbar.html' %}
      {% endif %}
    {% endif %}

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div style="margin-top:18px;">
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="flash-message {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
        </div>
      {% endif %}
    {% endwith %}

    <div style="margin-top:72px;"></div>
    <header style="display:flex; flex-direction:column; align-items:center; margin-bottom:18px;">
      <h2 style="margin:0 0 8px 0; font-weight:800; font-size:1.5em; text-align:center;">üèÜ Leaderboards</h2>
      <div style="margin-bottom:10px; color:var(--muted); text-align:center;">Local: <strong style="color:var(--primary-600)">{{ user_country }}</strong></div>
      <div class="leaderboard-toggle" style="display:flex; gap:10px; justify-content:center; margin-bottom:0;">
        <button id="globalBtn" class="toggle-btn active" type="button">Global</button>
        <button id="localBtn" class="toggle-btn" type="button">Local</button>
      </div>
    </header>
      <script>
        // Highlight active nav link
        document.addEventListener('DOMContentLoaded', function() {
          var path = window.location.pathname;
          document.querySelectorAll('.mobile-navbar .nav-links a').forEach(function(a) {
            if (a.getAttribute('href') === path) a.classList.add('active');
          });
          // Restore nav scroll position
          var nav = document.querySelector('.mobile-navbar .nav-links');
          if (nav) {
            var pos = localStorage.getItem('motonav_scroll');
            if (pos) nav.scrollLeft = parseInt(pos, 10);
            nav.addEventListener('scroll', function() {
              localStorage.setItem('motonav_scroll', nav.scrollLeft);
            });
          }
        });
      </script>

    <section class="leaderboard-section" style="margin-top:18px;">
      <!-- Toggleable Leaderboards -->
      <div id="globalLeaderboard" class="leaderboard-mobile-card" style="background:var(--card-bg); padding:10px 0 0 0; border-radius:18px; box-shadow:var(--shadow-1); width:100%; max-width:480px; margin:0 auto; margin-top:24px;">
        <div style="padding:0 18px 10px 18px; display:flex; align-items:center; justify-content:space-between;">
          <div style="font-weight:700; color:var(--muted); font-size:1.1em;">üåç Global Top Riders</div>
          <span style="font-size:1.1em; color:var(--primary-600); font-weight:700;">#</span>
        </div>
        <div style="display:flex; flex-direction:column; gap:0;">
          {% for user in global_leaderboard %}
            <a href="/user/{{ user['id'] }}" class="leaderboard-row-mobile{% if session['user_id'] == user['id'] %} leaderboard-self{% endif %}" style="display:flex; align-items:center; gap:12px; text-decoration:none; color:var(--text); padding:12px 14px; border-bottom:1px solid var(--n-300);{% if session['user_id'] == user['id'] %} box-shadow:0 0 0 2.5px var(--primary-500) inset;{% endif %}">
              <span style="font-size:1.2em; font-weight:800; width:28px; text-align:right; color:var(--primary-600);">{{ loop.index }}</span>
              <div style="width:44px; height:44px; border-radius:50%; overflow:hidden; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,var(--n-200),var(--n-100)); box-shadow:var(--shadow-1);">
                {% if user['profile_pic'] %}
                  <img src="{{ user['profile_pic'] }}" style="width:100%; height:100%; object-fit:cover;">
                {% else %}
                  <div style="font-weight:800; color:var(--primary-600); font-size:1.2em;">{{ user['username'][0].upper() }}</div>
                {% endif %}
              </div>
              <div style="flex:1; min-width:0;">
                <div style="font-weight:800; font-size:1.08em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ user['username'] }}</div>
                <div style="color:var(--muted); font-size:0.97em; margin-top:2px;">{{ user['country'] }}</div>
              </div>
              <div class="km-value" data-km="{{ user['total_distance']|default(0) }}" style="font-weight:800; color:var(--primary-600); font-size:1.08em; min-width:60px; text-align:right; letter-spacing:0.5px;">{{ user['total_distance']|default(0)|human_metric('km') }}</div>
            </a>
          {% else %}
            <div style="color:var(--muted); padding:12px;">No data yet.</div>
          {% endfor %}
        </div>
      </div>
      <div id="localLeaderboard" class="leaderboard-mobile-card" style="background:var(--card-bg); padding:10px 0 0 0; border-radius:18px; box-shadow:var(--shadow-1); width:100%; max-width:480px; margin:0 auto; margin-top:24px; display:none;">
        <div style="padding:0 18px 10px 18px; display:flex; align-items:center; justify-content:space-between;">
          <div style="font-weight:700; color:var(--muted); font-size:1.1em;">üè† Local Top Riders</div>
          <span style="font-size:1.1em; color:var(--primary-600); font-weight:700;">#</span>
        </div>
        <div style="display:flex; flex-direction:column; gap:0;">
          {% for user in local_leaderboard %}
            <a href="/user/{{ user['id'] }}" class="leaderboard-row-mobile{% if session['user_id'] == user['id'] %} leaderboard-self{% endif %}" style="display:flex; align-items:center; gap:12px; text-decoration:none; color:var(--text); padding:12px 14px; border-bottom:1px solid var(--n-300);{% if session['user_id'] == user['id'] %} box-shadow:0 0 0 2.5px var(--primary-500) inset;{% endif %}">
              <span style="font-size:1.2em; font-weight:800; width:28px; text-align:right; color:var(--primary-600);">{{ loop.index }}</span>
              <div style="width:44px; height:44px; border-radius:50%; overflow:hidden; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,var(--n-200),var(--n-100)); box-shadow:var(--shadow-1);">
                {% if user['profile_pic'] %}
                  <img src="{{ user['profile_pic'] }}" style="width:100%; height:100%; object-fit:cover;">
                {% else %}
                  <div style="font-weight:800; color:var(--primary-600); font-size:1.2em;">{{ user['username'][0].upper() }}</div>
                {% endif %}
              </div>
              <div style="flex:1; min-width:0;">
                <div style="font-weight:800; font-size:1.08em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ user['username'] }}</div>
                <div class="km-value" data-km="{{ user['total_distance']|default(0) }}" style="color:var(--muted); font-size:0.97em; margin-top:2px; letter-spacing:0.5px;">{{ user['total_distance']|default(0)|human_metric('km') }}</div>
              </div>
            </a>
          {% else %}
            <div style="color:var(--muted); padding:12px;">No local riders yet.</div>
          {% endfor %}
        </div>
        <div style="margin-top:14px; display:flex; gap:8px; padding:0 18px 18px 18px;">
          <a href="/leaderboard" class="btn" style="flex:1;">Refresh</a>
          <a href="/dashboard" class="btn btn-secondary" style="flex:1;">My dashboard</a>
        </div>
      </div>
    </section>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Theme init (fix dark mode toggle)
        const saved = localStorage.getItem('moto_theme');
        if (saved === 'dark') document.body.classList.add('dark');
        else document.body.classList.remove('dark');

        var globalBtn = document.getElementById('globalBtn');
        var localBtn = document.getElementById('localBtn');
        var globalBoard = document.getElementById('globalLeaderboard');
        var localBoard = document.getElementById('localLeaderboard');
        if (globalBtn && localBtn && globalBoard && localBoard) {
          globalBtn.addEventListener('click', function() {
            globalBtn.classList.add('active');
            localBtn.classList.remove('active');
            globalBoard.style.display = '';
            localBoard.style.display = 'none';
          });
          localBtn.addEventListener('click', function() {
            localBtn.classList.add('active');
            globalBtn.classList.remove('active');
            localBoard.style.display = '';
            globalBoard.style.display = 'none';
          });
        }
      });
    </script>