<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MotoLog - Create Event</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <style>
    .form-container { max-width: 700px; margin: 0 auto; }
    .form-section { background: var(--card-bg); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: var(--shadow-1); border-left: 4px solid var(--primary-500); }
    .form-section h3 { margin: 0 0 1rem 0; color: var(--text); font-size: 1.1rem; }
    .form-group { margin-bottom: 1.2rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text); }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; padding: 0.8rem; border: 1px solid color-mix(in srgb, var(--muted) 20%, transparent);
      border-radius: 8px; background: transparent; color: var(--text); font-family: inherit; font-size: inherit;
    }
    .form-group textarea { resize: vertical; min-height: 120px; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none; border-color: var(--primary-500);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-500) 10%, transparent);
    }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .coordinates-input { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .help-text { font-size: 0.85rem; color: var(--muted); margin-top: 0.3rem; }
    .time-input-wrap { position: relative; display: flex; gap: 8px; align-items: center; }
    .time-input-wrap input { flex: 1; }
    .time-picker-toggle {
      border: 1px solid color-mix(in srgb, var(--muted) 20%, transparent);
      background: color-mix(in srgb, var(--primary-500) 10%, transparent);
      color: var(--text);
      border-radius: 8px;
      padding: 0.72rem 0.85rem;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
    }
    .time-picker-panel {
      position: absolute;
      top: calc(100% + 6px);
      right: 0;
      z-index: 20;
      min-width: 220px;
      background: var(--card-bg);
      border: 1px solid color-mix(in srgb, var(--muted) 20%, transparent);
      border-radius: 10px;
      box-shadow: var(--shadow-2);
      padding: 10px;
    }
    .time-picker-panel[hidden] { display: none !important; }
    .time-picker-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center; }
    .time-picker-grid select {
      width: 100%; padding: 0.55rem; border: 1px solid color-mix(in srgb, var(--muted) 20%, transparent);
      border-radius: 8px; background: transparent; color: var(--text);
    }
    .time-picker-actions { display: flex; justify-content: flex-end; margin-top: 10px; }
    .time-picker-apply {
      border: none; border-radius: 8px; padding: 0.5rem 0.8rem; cursor: pointer;
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600)); color: #fff; font-weight: 600;
    }
    
    /* Enhanced file upload styling */
    .file-input-wrapper {
      position: relative; overflow: hidden; display: inline-block; width: 100%;
    }
    .file-input-label {
      display: flex; align-items: center; justify-content: center; gap: 0.8rem;
      padding: 2rem; border: 2px dashed var(--primary-500); border-radius: 8px;
      background: color-mix(in srgb, var(--primary-500) 5%, transparent); cursor: pointer;
      transition: all 0.2s; font-weight: 500; color: var(--primary-600);
    }
    .file-input-label:hover {
      background: color-mix(in srgb, var(--primary-500) 10%, transparent);
      border-color: var(--primary-600);
    }
    #cover_image { display: none; }
    #file-name { font-size: 0.9rem; color: var(--muted); margin-top: 0.5rem; }
    
    /* Enhanced scope selector */
    .scope-selector {
      display: flex; gap: 0.5rem; background: color-mix(in srgb, var(--muted) 10%, transparent);
      border-radius: 8px; padding: 0.3rem;
    }
    .scope-option {
      flex: 1; padding: 0.8rem; border: none; border-radius: 6px; cursor: pointer;
      background: transparent; color: var(--text); font-weight: 600; transition: all 0.2s;
      text-align: center;
    }
    .scope-option:hover { background: color-mix(in srgb, var(--primary-500) 15%, transparent); }
    .scope-option.active {
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
      color: white;
    }
    
    .btn-submit {
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
      color: white; padding: 1rem 2rem; border: none; border-radius: 8px;
      font-weight: 600; cursor: pointer; font-size: 1rem; width: 100%;
      transition: all 0.2s;
    }
    .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(86,118,240,0.2); }
    .map-note { background: color-mix(in srgb, var(--primary-500) 10%, transparent); padding: 1rem;
      border-radius: 8px; border-left: 4px solid var(--primary-500); margin-bottom: 1.5rem; }
    .map-note p { margin: 0; color: var(--text); font-size: 0.95rem; }
  </style>
</head>
<body>
  <div class="dashboard-container">
    {% if not request.args.get('app') %}
      {% include '_navbar.html' %}
    {% endif %}

    <div class="form-container events-create-form">
      <h1 style="margin-top: 0;">üèçÔ∏è Create New Event</h1>
      
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-messages">
            {% for category, message in messages %}
              <div class="flash-message {{ category }}">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <form method="POST" enctype="multipart/form-data">
        <!-- Basic Info -->
        <div class="form-section">
          <h3>üìù Event Details</h3>
          
          <div class="form-group">
            <label for="title">Event Title *</label>
            <input type="text" id="title" name="title" required placeholder="e.g., Mountain Loop Ride, Sunday Coffee Meetup" value="{{ form_data.get('title', '') }}">
            <p class="help-text">Give your event a catchy, descriptive title (minimum 3 characters)</p>
          </div>

          <div class="form-group">
            <label for="description">Description *</label>
            <textarea id="description" name="description" required placeholder="Describe the event in detail. What should riders expect? What's the difficulty level?">{{ form_data.get('description', '') }}</textarea>
            <p class="help-text">Minimum 10 characters. Be descriptive to attract participants</p>
          </div>

          <div class="form-group">
            <label for="category">Event Type *</label>
            <select id="category" name="category" required>
              <option value="">-- Select Event Type --</option>
              {% for cat_key, cat_label in categories.items() %}
                <option value="{{ cat_key }}" {% if form_data.get('category') == cat_key %}selected{% endif %}>{{ cat_label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Date & Time -->
        <div class="form-section">
          <h3>üìÖ When?</h3>
          
          <div class="form-group">
            <label for="event_date">Date & Time *</label>
            <input type="hidden" id="event_date" name="event_date" value="{{ form_data.get('event_date', '') }}">
            <div class="form-row">
              <div>
                <label for="event_date_date" style="font-weight: 500; font-size: 0.9rem; margin-bottom: 0.3rem;">Date</label>
                <input type="date" id="event_date_date" required>
              </div>
              <div>
                <label for="event_date_time" style="font-weight: 500; font-size: 0.9rem; margin-bottom: 0.3rem;">Time</label>
                <div class="time-input-wrap" id="timePickerWrap">
                  <input type="text" id="event_date_time" required inputmode="numeric" pattern="([01][0-9]|2[0-3]):[0-5][0-9]" placeholder="HH:MM" maxlength="5" title="Use 24-hour format HH:MM">
                  <button type="button" id="timePickerToggle" class="time-picker-toggle" aria-label="Open time picker">üïí</button>
                  <div id="timePickerPanel" class="time-picker-panel" hidden>
                    <div class="time-picker-grid">
                      <select id="timePickerHour" aria-label="Hour"></select>
                      <span>:</span>
                      <select id="timePickerMinute" aria-label="Minute"></select>
                    </div>
                    <div class="time-picker-actions">
                      <button type="button" id="timePickerApply" class="time-picker-apply">Set time</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <p class="help-text">Event must be scheduled for the future. Time uses 24-hour format (HH:MM).</p>
          </div>
        </div>

        <!-- Location -->
        <div class="form-section">
          <h3>üìç Where?</h3>
          
          <div class="form-group">
            <label for="city">City *</label>
            <select id="city" name="city" required>
              <option value="">-- Select a city --</option>
              {% for c in cities %}
                <option value="{{ c }}" {% if form_data.get('city') == c %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
            </select>
            <p class="help-text">The city where the event takes place</p>
          </div>

          <div class="form-group">
            <label for="location_name">Specific Location Name *</label>
            <input type="text" id="location_name" name="location_name" required placeholder="e.g., Shell Gas Station, Main Plaza" value="{{ form_data.get('location_name', '') }}">
            <p class="help-text">More specific location details within the city</p>
          </div>

          <div class="map-note">
            <p><strong>üí° GPS Coordinates (Optional):</strong> Use Google Maps to find exact coordinates for better navigation. Right-click on the location and copy the coordinates.</p>
          </div>

          <div class="form-group">
            <label>GPS Coordinates (Optional)</label>
            <div class="coordinates-input">
              <div>
                <label style="font-weight: 500; font-size: 0.9rem; margin-bottom: 0.3rem;">Latitude</label>
                <div style="display:flex; gap:8px; align-items:center;">
                  <input id="latitude" type="number" name="latitude" placeholder="42.6977" step="any" value="{{ form_data.get('latitude', '') }}">
                  <button type="button" id="pasteCoordsBtn" class="scope-option" style="padding:6px 10px; font-weight:600;">üìã Paste</button>
                </div>
              </div>
              <div>
                <label style="font-weight: 500; font-size: 0.9rem; margin-bottom: 0.3rem;">Longitude</label>
                <input id="longitude" type="number" name="longitude" placeholder="23.3219" step="any" value="{{ form_data.get('longitude', '') }}">
              </div>
            </div>
            <p class="help-text">If you provide coordinates, a map will be shown on the event page</p>
          </div>
        </div>

        <!-- Capacity & Media -->
        <div class="form-section">
          <h3>‚öôÔ∏è Settings</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="max_participants">Max Participants (Optional)</label>
              <input type="number" id="max_participants" name="max_participants" min="1" placeholder="Leave empty for unlimited" value="{{ form_data.get('max_participants', '') }}">
              <p class="help-text">Set a cap on participants or leave empty for unlimited</p>
            </div>
          </div>

          <!-- Enhanced file upload -->
          <div class="form-group">
            <label for="cover_image">Cover Image (Optional)</label>
            <div class="file-input-wrapper">
              <label for="cover_image" class="file-input-label">
                <span>üì∏ Click to upload or drag & drop</span>
                <span style="font-size: 0.85rem; color: var(--muted);">JPG, PNG, GIF (max 5MB)</span>
              </label>
              <input type="file" id="cover_image" name="cover_image" accept="image/*">
              <div id="file-name"></div>
            </div>
          </div>
        </div>

        <!-- Visibility -->
        <div class="form-section">
          <h3>üåç Event Scope</h3>
          
          <div class="form-group">
            <p style="margin: 0 0 1rem 0; color: var(--muted); font-size: 0.95rem;">Choose whether this event is visible to riders in your country or worldwide</p>
            <div class="scope-selector">
              <button type="button" class="scope-option active" data-scope="local" onclick="selectScope('local', this)">
                üìç Local (Your Country)
              </button>
              <button type="button" class="scope-option" data-scope="global" onclick="selectScope('global', this)">
                üåç Global
              </button>
            </div>
            <input type="hidden" id="is_local_hidden" name="is_local" value="{{ form_data.get('is_local', 'on') }}">
          </div>
        </div>

        <!-- Submit -->
        <button type="submit" class="btn-submit">‚ú® Create Event</button>
      </form>
    </div>
  </div>

  <script>
    function splitEventDateValue(raw) {
      if (!raw) return { date: '', time: '' };
      const normalized = raw.replace(' ', 'T');
      const parts = normalized.split('T');
      if (parts.length < 2) return { date: '', time: '' };
      return { date: parts[0], time: parts[1].slice(0, 5) };
    }

    function syncEventDateHidden() {
      const dateVal = document.getElementById('event_date_date').value;
      const timeVal = document.getElementById('event_date_time').value;
      document.getElementById('event_date').value = (dateVal && timeVal) ? `${dateVal}T${timeVal}` : '';
    }

    function normalize24HourTime(raw) {
      if (!raw) return '';
      const value = String(raw).trim();
      const direct = value.match(/^([01]?\d|2[0-3]):([0-5]\d)$/);
      if (direct) {
        const hh = String(parseInt(direct[1], 10)).padStart(2, '0');
        return `${hh}:${direct[2]}`;
      }
      const compact = value.match(/^([01]?\d|2[0-3])([0-5]\d)$/);
      if (compact) {
        const hh = String(parseInt(compact[1], 10)).padStart(2, '0');
        return `${hh}:${compact[2]}`;
      }
      return '';
    }

    const eventDateHidden = document.getElementById('event_date');
    const eventDateDate = document.getElementById('event_date_date');
    const eventDateTime = document.getElementById('event_date_time');
    const timePickerWrap = document.getElementById('timePickerWrap');
    const timePickerToggle = document.getElementById('timePickerToggle');
    const timePickerPanel = document.getElementById('timePickerPanel');
    const timePickerHour = document.getElementById('timePickerHour');
    const timePickerMinute = document.getElementById('timePickerMinute');
    const timePickerApply = document.getElementById('timePickerApply');

    for (let hour = 0; hour < 24; hour += 1) {
      const option = document.createElement('option');
      option.value = String(hour).padStart(2, '0');
      option.textContent = option.value;
      timePickerHour.appendChild(option);
    }
    for (let minute = 0; minute < 60; minute += 1) {
      const option = document.createElement('option');
      option.value = String(minute).padStart(2, '0');
      option.textContent = option.value;
      timePickerMinute.appendChild(option);
    }

    function applyTimeToInput(hh, mm) {
      eventDateTime.value = `${hh}:${mm}`;
      eventDateTime.setCustomValidity('');
      syncEventDateHidden();
    }

    function openTimePicker() {
      const normalized = normalize24HourTime(eventDateTime.value) || '00:00';
      const parts = normalized.split(':');
      timePickerHour.value = parts[0];
      timePickerMinute.value = parts[1];
      timePickerPanel.hidden = false;
    }

    function closeTimePicker() {
      timePickerPanel.hidden = true;
    }

    const prefill = splitEventDateValue(eventDateHidden.value || '');
    eventDateDate.value = prefill.date;
    eventDateTime.value = prefill.time;
    eventDateTime.addEventListener('blur', function () {
      const normalized = normalize24HourTime(eventDateTime.value);
      if (normalized) {
        eventDateTime.value = normalized;
        eventDateTime.setCustomValidity('');
        syncEventDateHidden();
      } else if (eventDateTime.value) {
        eventDateTime.setCustomValidity('Please enter time as HH:MM in 24-hour format.');
      } else {
        eventDateTime.setCustomValidity('');
      }
    });
    eventDateTime.addEventListener('focus', openTimePicker);
    eventDateTime.addEventListener('input', function () {
      eventDateTime.setCustomValidity('');
      const normalized = normalize24HourTime(eventDateTime.value);
      if (normalized) {
        eventDateTime.value = normalized;
        syncEventDateHidden();
      }
    });
    timePickerToggle.addEventListener('click', function () {
      if (timePickerPanel.hidden) {
        openTimePicker();
      } else {
        closeTimePicker();
      }
    });
    timePickerApply.addEventListener('click', function () {
      applyTimeToInput(timePickerHour.value, timePickerMinute.value);
      closeTimePicker();
      eventDateTime.focus();
    });
    document.addEventListener('click', function (event) {
      if (!timePickerWrap.contains(event.target)) {
        closeTimePicker();
      }
    });
    eventDateDate.addEventListener('change', syncEventDateHidden);
    eventDateTime.addEventListener('change', syncEventDateHidden);

    // File upload visualization
    document.getElementById('cover_image').addEventListener('change', function(e) {
      const fileName = e.target.files[0]?.name || '';
      document.getElementById('file-name').textContent = fileName ? '‚úÖ ' + fileName : '';
    });

    // Scope selector
    function selectScope(scope, element) {
      document.querySelectorAll('.scope-option').forEach(el => el.classList.remove('active'));
      element.classList.add('active');
      document.getElementById('is_local_hidden').value = scope === 'local' ? 'on' : 'off';
    }

    const scopeValue = document.getElementById('is_local_hidden').value;
    const scopeToActivate = scopeValue === 'off' ? 'global' : 'local';
    const scopeButton = document.querySelector(`.scope-option[data-scope="${scopeToActivate}"]`);
    if (scopeButton) {
      document.querySelectorAll('.scope-option').forEach(el => el.classList.remove('active'));
      scopeButton.classList.add('active');
    }

    // Paste coords helper: supports pasted Google Maps coords like "42.6977, 23.3219"
    function parseCoordsFromText(text) {
      if (!text) return null;
      // find two floats (with optional +/- and decimals)
      const m = text.match(/([-+]?\d{1,3}\.\d{1,20})[^0-9+-]*([-+]?\d{1,3}\.\d{1,20})/);
      if (!m) return null;
      const lat = parseFloat(m[1]);
      const lon = parseFloat(m[2]);
      if (isNaN(lat) || isNaN(lon)) return null;
      // Keep full precision as copied
      return { lat: lat, lon: lon };
    }

    const latInput = document.getElementById('latitude');
    const lonInput = document.getElementById('longitude');
    const pasteBtn = document.getElementById('pasteCoordsBtn');

    if (latInput) {
      // handle manual paste into latitude field
      latInput.addEventListener('paste', function(e){
        try {
          const text = (e.clipboardData || window.clipboardData).getData('text') || '';
          const coords = parseCoordsFromText(text);
          if (coords) {
            e.preventDefault();
            latInput.value = coords.lat;
            if (lonInput) lonInput.value = coords.lon;
          }
        } catch (err) { /* ignore */ }
      });
    }

    if (pasteBtn) {
      pasteBtn.addEventListener('click', async function(){
        try {
          const text = await (navigator.clipboard && navigator.clipboard.readText ? navigator.clipboard.readText() : Promise.resolve(''));
          const coords = parseCoordsFromText(text || '');
          if (coords) {
            latInput.value = coords.lat;
            lonInput.value = coords.lon;
          } else {
            alert('No coordinates detected in clipboard. Copy coordinates from Google Maps (right-click ‚Üí Copy coordinates).');
          }
        } catch (err) {
          alert('Unable to read clipboard. Try pasting directly into the latitude field.');
        }
      });
    }

    const createEventForm = document.querySelector('form[method="POST"]');
    if (createEventForm) {
      createEventForm.addEventListener('submit', function () {
        syncEventDateHidden();
      });
    }
  </script>
</body>
</html>