{% extends 'base_mobile.html' %}
{% block title %}Add Bike{% endblock %}
{% block content %}
{% if not request.args.get('app') %}
  {% include '_navbar.html' %}
{% endif %}
<div class="mobile-container" style="padding:8px;">
  <div class="form-card" style="max-width:100%;margin:0 auto;padding:1rem;background:var(--card-bg);border-radius:10px;box-shadow:var(--shadow-1);">
    <h2 style="color:var(--primary-600);font-size:1.2em;">üèçÔ∏è Add Your Bike</h2>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="flash-message {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    <form method="POST" enctype="multipart/form-data">
      <div class="form-group" style="margin-bottom:1rem;">
        <label for="name">Bike Name</label>
        <input type="text" id="name" name="name" placeholder="e.g. My Street Bike" required style="width:100%;padding:10px;border-radius:8px;">
      </div>
      <div class="form-group" style="margin-bottom:1rem;">
        <label for="make_model">Make / Model</label>
        <input type="text" id="make_model" name="make_model" placeholder="e.g. Honda CB500" style="width:100%;padding:10px;border-radius:8px;">
      </div>
      <div class="form-group" style="margin-bottom:1rem;">
        <label for="year">Year</label>
        <input type="number" id="year" name="year" placeholder="2020" min="1900" max="2100" style="width:100%;padding:10px;border-radius:8px;">
      </div>
      <div class="form-group" style="margin-bottom:1rem;">
        <label for="odo">Current Odometer (km)</label>
        <input type="number" id="odo" name="odo" step="0.1" placeholder="5000" value="0" style="width:100%;padding:10px;border-radius:8px;">
      </div>
      <div class="form-group" style="margin-bottom:1rem;">
        <label for="bike_image">Bike Photo</label>
        <label class="upload-btn" style="display:block;padding:8px;border-radius:8px;background:var(--n-100);border:1px solid var(--n-300);">
          <span class="icon">üñºÔ∏è</span>
          <span>Choose Photo</span>
          <input class="hidden-file-input" type="file" id="bike_image" name="bike_image" accept="image/*" onchange="updatePreview(this, 'bikePreview')" style="display:none;">
        </label>
        <span id="bikePreview" class="file-preview"></span>
        <div id="bikeThumbs" style="display:none; margin-top:8px;"></div>
        <div class="upload-note" style="font-size:0.9em;color:var(--muted);">JPG, PNG, GIF (max size: 5MB)</div>
      </div>
      <div class="form-group" style="margin-bottom:1rem;">
        <label for="bike_photos">Additional Photos</label>
        <label class="upload-btn" style="display:block;padding:8px;border-radius:8px;background:var(--n-100);border:1px solid var(--n-300);">
          <span class="icon">üì∏</span>
          <span>Choose Photos</span>
          <input class="hidden-file-input" type="file" id="bike_photos" name="bike_photos" accept="image/*" multiple onchange="updatePreview(this, 'photosPreview')" style="display:none;">
        </label>
        <span id="photosPreview" class="file-preview"></span>
        <div id="photosThumbs" style="display:none; margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;"></div>
        <div class="upload-note" style="font-size:0.9em;color:var(--muted);">JPG, PNG, GIF, WEBP, AVIF, HEIC (max size: 5MB each)</div>
      </div>
      <div class="form-group" style="margin-bottom:1rem;">
        <label for="notes">Notes / Description</label>
        <textarea id="notes" name="notes" rows="3" placeholder="Add details about your bike..." style="width:100%;padding:10px;border-radius:8px;"></textarea>
      </div>
      <div class="form-group" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-bottom:1rem;">
        <div class="toggle">
          <label style="font-weight:600; color:var(--text);">Visibility</label>
          <label class="switch">
            <input type="checkbox" name="is_private">
            <span class="knob"></span>
          </label>
          <div style="color:var(--muted); font-size:0.9em;">Toggle to mark private</div>
        </div>
        <div style="text-align:right;">
          <button type="submit" class="btn" style="padding:10px 18px;border-radius:8px;">Add Bike</button>
        </div>
      </div>
    </form>
  </div>
</div>
<script>
function updatePreview(input, targetId) {
  const label = document.getElementById(targetId);
  const thumbsContainer = targetId === 'bikePreview'
    ? document.getElementById('bikeThumbs')
    : document.getElementById('photosThumbs');

  if (!input.files || !input.files.length) { label.textContent = ''; return; }
  if (input.multiple) {
    const names = Array.from(input.files).map(file => file.name);
    label.textContent = names.join(', ');
  } else {
    label.textContent = input.files[0].name;
  }

  if (!thumbsContainer) {
    return;
  }

  thumbsContainer.innerHTML = '';
  thumbsContainer.style.display = 'flex';

  Array.from(input.files).forEach((file) => {
    if (!file.type.startsWith('image/')) {
      return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = document.createElement('img');
      img.src = e.target.result;
      img.alt = file.name;
      img.style.width = targetId === 'bikePreview' ? '150px' : '80px';
      img.style.height = targetId === 'bikePreview' ? '100px' : '80px';
      img.style.objectFit = 'cover';
      img.style.borderRadius = '8px';
      img.style.border = '1px solid var(--n-300)';
      thumbsContainer.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
}
</script>
{% endblock %}
