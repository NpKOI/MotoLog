<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MotoLog - {{ user['username'] }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
  <div class="dashboard-container">
    {% include '_navbar.html' %}

    <!-- Profile Header -->
    <div class="profile-header">
      <div class="profile-avatar-large{% if user['profile_pic'] %} {% else %} circle{% endif %}">
        {% if user['profile_pic'] %}
          <a href="/user/{{ user['id'] }}" aria-label="{{ user['username'] }}'s profile">
            <img src="{{ user['profile_pic'] }}" alt="{{ user['username'] }}">
          </a>
        {% else %}
          <a href="/user/{{ user['id'] }}" aria-label="{{ user['username'] }}'s profile" style="display:flex; width:100%; height:100%; align-items:center; justify-content:center; text-decoration:none; color:white; font-weight:800;">
            <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:3rem; background:linear-gradient(135deg,var(--primary-500),var(--primary-600));">
              {{ user['username'][0].upper() }}
            </div>
          </a>
        {% endif %}
      </div>

      <div class="profile-details">
        <h1 class="profile-username">{{ user['username'] }}</h1>

        <div class="profile-stats" style="margin-top:12px;">
          <a href="/user/{{ user['id'] }}" style="text-decoration:none; color:inherit;">
            <div class="stat">
              <div class="stat-value">{{ total_rides }}</div>
              <div class="stat-label">Public Rides</div>
            </div>
          </a>

          <a href="/user/{{ user['id'] }}/followers" style="text-decoration:none; color:inherit;">
            <div class="stat">
              <div class="stat-value">{{ followers|length }}</div>
              <div class="stat-label">Followers</div>
            </div>
          </a>

          <a href="/user/{{ user['id'] }}/following" style="text-decoration:none; color:inherit;">
            <div class="stat">
              <div class="stat-value">{{ following|length }}</div>
              <div class="stat-label">Following</div>
            </div>
          </a>
        </div>

        {% if user['bio'] %}
          <div class="profile-bio" style="margin-top:12px;">{{ user['bio'] }}</div>
        {% endif %}

        <div style="margin-top:10px; color:var(--muted); font-weight:700;">
          ğŸ“ {{ user['country'] }}
        </div>

        <div class="action-buttons" style="margin-top:14px;">
          {% if session.get('user_id') and session['user_id'] != user['id'] %}
            <form method="POST" action="/follow/{{ user['id'] }}" style="display:inline;">
              <button class="action-btn follow-btn {% if is_following %}unfollow{% endif %}" type="submit">
                {{ 'âœ“ Following' if is_following else '+ Follow' }}
              </button>
            </form>
            <a href="/messages/with/{{ user['id'] }}" class="action-btn message-btn">ğŸ’¬ Message</a>
          {% endif %}
          <a href="/user/{{ user['id'] }}/garage" class="action-btn garage-btn">ğŸï¸ Garage</a>
        </div>
      </div>
    </div>

    <!-- Public Rides -->
    <div class="profile-section" style="margin-top:18px;">
      <h3>ğŸï¸ Recent Public Rides ({{ rides|length }})</h3>
      <div style="margin-top:12px;">
        {% if rides %}
          {% for ride in rides %}
            <div class="ride-card-public">
              <div class="ride-date-public">ğŸ“… {{ ride['date'] }}</div>
              <div class="ride-details-public">ğŸ›£ï¸ {{ ride['distance'] }} km â€¢ â±ï¸ {{ ride['time'] }} hrs</div>
              {% if ride['description'] %}
                <div class="ride-description">{{ ride['description'] }}</div>
              {% endif %}

              <div class="comments-section">
                <div class="comments-title">ğŸ’¬ Comments</div>

                {% set ride_comments = query_db('SELECT c.*, u.username, u.profile_pic FROM comments c JOIN users u ON c.user_id = u.id WHERE c.ride_id = ? ORDER BY c.created_at DESC', (ride['id'],)) %}
                {% if ride_comments %}
                  {% for comment in ride_comments %}
                    <div class="comment">
                      <div class="comment-author">{{ comment['username'] }}</div>
                      <div class="comment-text">{{ comment['content'] }}</div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div style="color:var(--muted); font-size:0.95rem;">No comments yet. Be the first to comment!</div>
                {% endif %}

                {% if session.get('user_id') %}
                  <form method="POST" action="/ride/{{ ride['id'] }}/comment" class="comment-form">
                    <input type="text" name="comment" class="comment-input" placeholder="Share your thoughts..." required>
                    <button type="submit" class="comment-submit">Post</button>
                  </form>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">No public rides yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
</body>
</html>